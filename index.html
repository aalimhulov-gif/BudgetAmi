<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Семейный бюджет - Полная версия</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(102, 126, 234, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        z-index: 9999;
      }

      .loader {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .auth-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .auth-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      }

      .auth-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .auth-header h1 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .input-group {
        position: relative;
        margin-bottom: 20px;
      }

      .input-group input {
        width: 100%;
        padding: 15px 45px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .input-group i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
      }

      .btn {
        width: 100%;
        padding: 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        margin-bottom: 15px;
      }

      .btn:hover {
        background: #5a6fd8;
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .auth-switch {
        text-align: center;
        color: #666;
        cursor: pointer;
      }

      .auth-switch:hover {
        color: #667eea;
      }

      .main-app {
        display: none;
      }

      .main-app.active {
        display: block;
      }

      .app-nav {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .nav-brand {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
      }

      .nav-menu {
        display: flex;
        gap: 20px;
      }

      .nav-item {
        padding: 10px 20px;
        background: #f5f5f5;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .nav-item:hover,
      .nav-item.active {
        background: #667eea;
        color: white;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logout-btn {
        padding: 8px 15px;
        background: #ff4757;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .card:hover {
        transform: translateY(-3px);
      }

      .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: white;
      }

      .income {
        background: #27ae60;
      }
      .expense {
        background: #e74c3c;
      }
      .balance {
        background: #3498db;
      }

      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .card-amount {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 10px 0;
      }

      .transactions {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .transactions h3 {
        margin-bottom: 20px;
        color: #333;
      }

      .transaction-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .transaction-form input,
      .transaction-form select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      .transaction-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background 0.3s;
      }

      .transaction-item:hover {
        background: #f8f9fa;
      }

      .transaction-info {
        flex: 1;
      }

      .transaction-description {
        font-weight: 500;
        margin-bottom: 5px;
      }

      .transaction-category {
        font-size: 0.9rem;
        color: #666;
      }

      .transaction-amount {
        font-weight: bold;
        font-size: 1.1rem;
      }

      .transaction-amount.income {
        color: #27ae60;
      }

      .transaction-amount.expense {
        color: #e74c3c;
      }

      .transaction-date {
        font-size: 0.8rem;
        color: #999;
        margin-left: 15px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: #27ae60;
        color: white;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      }

      .notification.error {
        background: #e74c3c;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      .hidden {
        display: none !important;
      }

      /* Стили для новых секций */
      .category-item,
      .limit-item,
      .goal-item {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .category-item:hover,
      .limit-item:hover,
      .goal-item:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .category-info,
      .limit-info,
      .goal-info {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
      }

      .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
      }

      .category-name,
      .limit-category,
      .goal-name {
        font-weight: 600;
        color: var(--text-primary);
      }

      .category-type {
        color: var(--text-secondary);
        font-size: 14px;
      }

      .progress-bar {
        width: 200px;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin: 5px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--accent-color)
        );
        transition: width 0.3s ease;
      }

      .goal-actions {
        display: flex;
        gap: 10px;
      }

      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .analytics-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .analytics-card h3 {
        margin: 0 0 10px 0;
        color: var(--text-secondary);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .analytics-card .amount {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .category-stat {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }

      .category-stat:last-child {
        border-bottom: none;
      }

      .settings-section {
        max-width: 600px;
      }

      .settings-group {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .settings-group h3 {
        margin: 0 0 15px 0;
        color: var(--text-primary);
      }

      .btn-danger {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn-danger:hover {
        background: #c53030;
        transform: translateY(-1px);
      }

      @media (max-width: 768px) {
        .nav-menu {
          flex-direction: column;
          gap: 10px;
        }

        .transaction-form {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Экран загрузки -->
    <div id="loading-screen" class="loading-screen">
      <div class="loader"></div>
      <p>Инициализация Firebase...</p>
    </div>

    <!-- Экран авторизации -->
    <div id="auth-screen" class="auth-screen hidden">
      <div class="auth-container">
        <div class="auth-header">
          <h1><i class="fas fa-wallet"></i> Семейный бюджет</h1>
          <p>Управляйте финансами вместе</p>
        </div>

        <!-- Форма входа -->
        <div id="login-form">
          <div class="input-group">
            <i class="fas fa-envelope"></i>
            <input type="email" id="login-email" placeholder="Email" required />
          </div>
          <div class="input-group">
            <i class="fas fa-lock"></i>
            <input
              type="password"
              id="login-password"
              placeholder="Пароль"
              required
            />
          </div>
          <button id="login-btn" class="btn">Войти</button>
          <div class="auth-switch" onclick="toggleAuthForm()">
            Нет аккаунта? Зарегистрироваться
          </div>
        </div>

        <!-- Форма регистрации -->
        <div id="register-form" class="hidden">
          <div class="input-group">
            <i class="fas fa-user"></i>
            <input
              type="text"
              id="register-name"
              placeholder="Ваше имя"
              required
            />
          </div>
          <div class="input-group">
            <i class="fas fa-envelope"></i>
            <input
              type="email"
              id="register-email"
              placeholder="Email"
              required
            />
          </div>
          <div class="input-group">
            <i class="fas fa-lock"></i>
            <input
              type="password"
              id="register-password"
              placeholder="Пароль"
              required
            />
          </div>
          <button id="register-btn" class="btn">Зарегистрироваться</button>
          <div class="auth-switch" onclick="toggleAuthForm()">
            Уже есть аккаунт? Войти
          </div>
        </div>
      </div>
    </div>

    <!-- Основное приложение -->
    <div id="main-app" class="main-app">
      <div class="container">
        <!-- Навигация -->
        <div class="app-nav">
          <div class="nav-brand">
            <i class="fas fa-wallet"></i> Семейный бюджет
          </div>
          <div class="nav-menu">
            <div class="nav-item active" onclick="showSection('dashboard')">
              <i class="fas fa-chart-line"></i> Обзор
            </div>
            <div class="nav-item" onclick="showSection('transactions')">
              <i class="fas fa-list"></i> Операции
            </div>
            <div class="nav-item" onclick="showSection('categories')">
              <i class="fas fa-tags"></i> Категории
            </div>
            <div class="nav-item" onclick="showSection('limits')">
              <i class="fas fa-exclamation-triangle"></i> Лимиты
            </div>
            <div class="nav-item" onclick="showSection('goals')">
              <i class="fas fa-target"></i> Цели
            </div>
            <div class="nav-item" onclick="showSection('analytics')">
              <i class="fas fa-chart-pie"></i> Аналитика
            </div>
            <div class="nav-item" onclick="showSection('settings')">
              <i class="fas fa-cog"></i> Настройки
            </div>
          </div>
          <div class="user-info">
            <span id="user-name">Пользователь</span>
            <button class="logout-btn" onclick="logout()">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>

        <!-- Дашборд -->
        <div id="dashboard-section">
          <div class="dashboard">
            <div class="card">
              <div class="card-header">
                <div class="card-icon income">
                  <i class="fas fa-arrow-up"></i>
                </div>
                <div class="card-title">Доходы</div>
              </div>
              <div class="card-amount" id="total-income">0 ₽</div>
              <div>За текущий месяц</div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-icon expense">
                  <i class="fas fa-arrow-down"></i>
                </div>
                <div class="card-title">Расходы</div>
              </div>
              <div class="card-amount" id="total-expenses">0 ₽</div>
              <div>За текущий месяц</div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-icon balance">
                  <i class="fas fa-wallet"></i>
                </div>
                <div class="card-title">Баланс</div>
              </div>
              <div class="card-amount" id="balance">0 ₽</div>
              <div>Остаток средств</div>
            </div>
          </div>
        </div>

        <!-- Транзакции -->
        <div id="transactions-section" class="hidden">
          <div class="transactions">
            <h3><i class="fas fa-plus"></i> Добавить операцию</h3>
            <form class="transaction-form" id="transaction-form">
              <select id="transaction-type" required>
                <option value="">Тип операции</option>
                <option value="income">Доход</option>
                <option value="expense">Расход</option>
              </select>
              <input
                type="number"
                id="transaction-amount"
                placeholder="Сумма"
                required
              />
              <input
                type="text"
                id="transaction-description"
                placeholder="Описание"
                required
              />
              <select id="transaction-category" required>
                <option value="">Категория</option>
                <option value="food">Продукты</option>
                <option value="transport">Транспорт</option>
                <option value="utilities">Коммунальные</option>
                <option value="entertainment">Развлечения</option>
                <option value="salary">Зарплата</option>
                <option value="other">Другое</option>
              </select>
              <button type="submit" class="btn">Добавить</button>
            </form>

            <h3><i class="fas fa-history"></i> История операций</h3>
            <div class="transaction-list" id="transaction-list">
              <!-- Транзакции будут загружены сюда -->
            </div>
          </div>
        </div>

        <!-- Категории -->
        <div id="categories-section" class="hidden">
          <div class="transactions">
            <h3><i class="fas fa-tags"></i> Управление категориями</h3>

            <div class="transaction-form">
              <input
                type="text"
                id="category-name"
                placeholder="Название категории"
                required
              />
              <select id="category-type" required>
                <option value="">Тип категории</option>
                <option value="income">Доход</option>
                <option value="expense">Расход</option>
              </select>
              <input
                type="color"
                id="category-color"
                value="#667eea"
                title="Цвет категории"
              />
              <button type="button" onclick="addCategory()" class="btn">
                Добавить категорию
              </button>
            </div>

            <h3><i class="fas fa-list"></i> Мои категории</h3>
            <div class="transaction-list" id="categories-list">
              <!-- Категории будут загружены сюда -->
            </div>
          </div>
        </div>

        <!-- Лимиты -->
        <div id="limits-section" class="hidden">
          <div class="transactions">
            <h3><i class="fas fa-exclamation-triangle"></i> Лимиты расходов</h3>

            <div class="transaction-form">
              <select id="limit-category" required>
                <option value="">Выберите категорию</option>
                <option value="food">Продукты</option>
                <option value="transport">Транспорт</option>
                <option value="utilities">Коммунальные</option>
                <option value="entertainment">Развлечения</option>
                <option value="other">Другое</option>
              </select>
              <input
                type="number"
                id="limit-amount"
                placeholder="Сумма лимита"
                required
              />
              <select id="limit-period" required>
                <option value="">Период</option>
                <option value="week">Неделя</option>
                <option value="month">Месяц</option>
                <option value="year">Год</option>
              </select>
              <button type="button" onclick="addLimit()" class="btn">
                Установить лимит
              </button>
            </div>

            <h3><i class="fas fa-chart-bar"></i> Активные лимиты</h3>
            <div class="transaction-list" id="limits-list">
              <!-- Лимиты будут загружены сюда -->
            </div>
          </div>
        </div>

        <!-- Цели -->
        <div id="goals-section" class="hidden">
          <div class="transactions">
            <h3><i class="fas fa-target"></i> Финансовые цели</h3>

            <div class="transaction-form">
              <input
                type="text"
                id="goal-name"
                placeholder="Название цели"
                required
              />
              <input
                type="number"
                id="goal-amount"
                placeholder="Целевая сумма"
                required
              />
              <input type="date" id="goal-deadline" required />
              <input
                type="number"
                id="goal-current"
                placeholder="Текущая сумма"
                value="0"
              />
              <button type="button" onclick="addGoal()" class="btn">
                Создать цель
              </button>
            </div>

            <h3><i class="fas fa-bullseye"></i> Мои цели</h3>
            <div class="transaction-list" id="goals-list">
              <!-- Цели будут загружены сюда -->
            </div>
          </div>
        </div>

        <!-- Аналитика -->
        <div id="analytics-section" class="hidden">
          <div class="transactions">
            <h3><i class="fas fa-chart-pie"></i> Аналитика расходов</h3>

            <div class="dashboard">
              <div class="card">
                <div class="card-header">
                  <div class="card-icon expense">
                    <i class="fas fa-chart-line"></i>
                  </div>
                  <div class="card-title">Средние расходы</div>
                </div>
                <div class="card-amount" id="avg-expenses">0 ₽</div>
                <div>В день</div>
              </div>

              <div class="card">
                <div class="card-header">
                  <div class="card-icon income">
                    <i class="fas fa-trending-up"></i>
                  </div>
                  <div class="card-title">Самая популярная категория</div>
                </div>
                <div class="card-amount" id="top-category">-</div>
                <div>По количеству операций</div>
              </div>

              <div class="card">
                <div class="card-header">
                  <div class="card-icon balance">
                    <i class="fas fa-percentage"></i>
                  </div>
                  <div class="card-title">Экономия</div>
                </div>
                <div class="card-amount" id="savings-rate">0%</div>
                <div>От доходов</div>
              </div>
            </div>

            <h3><i class="fas fa-chart-bar"></i> Расходы по категориям</h3>
            <div class="transaction-list" id="analytics-list">
              <!-- Аналитика будет загружена сюда -->
            </div>
          </div>
        </div>

        <!-- Настройки -->
        <div id="settings-section" class="hidden">
          <div class="transactions">
            <h3><i class="fas fa-cog"></i> Настройки</h3>

            <div class="card" style="margin-bottom: 20px">
              <h4><i class="fas fa-user"></i> Профиль</h4>
              <div class="transaction-form">
                <input type="text" id="profile-name" placeholder="Ваше имя" />
                <input
                  type="email"
                  id="profile-email"
                  placeholder="Email"
                  disabled
                />
                <button type="button" onclick="updateProfile()" class="btn">
                  Обновить профиль
                </button>
              </div>
            </div>

            <div class="card" style="margin-bottom: 20px">
              <h4><i class="fas fa-palette"></i> Оформление</h4>
              <div class="transaction-form">
                <select id="theme-select">
                  <option value="light">Светлая тема</option>
                  <option value="dark">Темная тема</option>
                  <option value="auto">Системная</option>
                </select>
                <select id="currency-select">
                  <option value="RUB">Рубли (₽)</option>
                  <option value="USD">Доллары ($)</option>
                  <option value="EUR">Евро (€)</option>
                </select>
                <button type="button" onclick="updateSettings()" class="btn">
                  Применить
                </button>
              </div>
            </div>

            <div class="card" style="margin-bottom: 20px">
              <h4><i class="fas fa-users"></i> Семейный доступ</h4>
              <div class="transaction-form">
                <input
                  type="email"
                  id="invite-email"
                  placeholder="Email члена семьи"
                />
                <button type="button" onclick="inviteUser()" class="btn">
                  Пригласить
                </button>
              </div>
              <div id="family-members">
                <!-- Члены семьи будут здесь -->
              </div>
            </div>

            <div class="card">
              <h4><i class="fas fa-download"></i> Экспорт данных</h4>
              <div class="transaction-form">
                <button type="button" onclick="exportData('csv')" class="btn">
                  Экспорт в CSV
                </button>
                <button type="button" onclick="exportData('json')" class="btn">
                  Экспорт в JSON
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
      // Firebase configuration
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        updateProfile,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        onSnapshot,
        where,
        doc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      // Firebase config - ЗАМЕНИТЕ НА ВАШУ КОНФИГУРАЦИЮ
      const firebaseConfig = {
        apiKey: "AIzaSyCGN93LsNnRGcqGpesVWAg8jP0m6XsQAuA",
        authDomain: "budget-ami.firebaseapp.com",
        databaseURL:
          "https://budget-ami-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "budget-ami",
        storageBucket: "budget-ami.firebasestorage.app",
        messagingSenderId: "976854941281",
        appId: "1:976854941281:web:f40e81033cf52d236af420",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let transactions = [];

      // UI Elements
      const loadingScreen = document.getElementById("loading-screen");
      const authScreen = document.getElementById("auth-screen");
      const mainApp = document.getElementById("main-app");

      // Auth elements
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const loginBtn = document.getElementById("login-btn");
      const registerBtn = document.getElementById("register-btn");

      // App elements
      const userNameEl = document.getElementById("user-name");
      const totalIncomeEl = document.getElementById("total-income");
      const totalExpensesEl = document.getElementById("total-expenses");
      const balanceEl = document.getElementById("balance");
      const transactionForm = document.getElementById("transaction-form");
      const transactionList = document.getElementById("transaction-list");

      // Global functions
      window.toggleAuthForm = function () {
        loginForm.classList.toggle("hidden");
        registerForm.classList.toggle("hidden");
      };

      window.showSection = function (section) {
        document
          .querySelectorAll(".nav-item")
          .forEach((item) => item.classList.remove("active"));
        event.target.closest(".nav-item").classList.add("active");

        // Скрываем все секции
        document.getElementById("dashboard-section").classList.add("hidden");
        document.getElementById("transactions-section").classList.add("hidden");
        document.getElementById("categories-section").classList.add("hidden");
        document.getElementById("limits-section").classList.add("hidden");
        document.getElementById("goals-section").classList.add("hidden");
        document.getElementById("analytics-section").classList.add("hidden");
        document.getElementById("settings-section").classList.add("hidden");

        // Показываем нужную секцию
        if (section === "dashboard") {
          document
            .getElementById("dashboard-section")
            .classList.remove("hidden");
        } else if (section === "transactions") {
          document
            .getElementById("transactions-section")
            .classList.remove("hidden");
        } else if (section === "categories") {
          document
            .getElementById("categories-section")
            .classList.remove("hidden");
          loadCategories();
        } else if (section === "limits") {
          document.getElementById("limits-section").classList.remove("hidden");
          loadLimits();
        } else if (section === "goals") {
          document.getElementById("goals-section").classList.remove("hidden");
          loadGoals();
        } else if (section === "analytics") {
          document
            .getElementById("analytics-section")
            .classList.remove("hidden");
          loadAnalytics();
        } else if (section === "settings") {
          document
            .getElementById("settings-section")
            .classList.remove("hidden");
          loadSettings();
        }
      };

      window.logout = async function () {
        try {
          await signOut(auth);
        } catch (error) {
          showNotification("Ошибка выхода: " + error.message, "error");
        }
      };

      // Категории
      window.loadCategories = async function () {
        if (!auth.currentUser) return;

        const categoriesRef = collection(
          db,
          `users/${auth.currentUser.uid}/categories`
        );
        const q = query(categoriesRef, orderBy("name"));

        const snapshot = await getDocs(q);
        const categoriesList = document.getElementById("categories-list");
        categoriesList.innerHTML = "";

        snapshot.forEach((doc) => {
          const category = doc.data();
          const categoryElement = document.createElement("div");
          categoryElement.className = "category-item";
          categoryElement.innerHTML = `
            <div class="category-info">
              <div class="category-icon" style="background: ${category.color}">${category.icon}</div>
              <div>
                <div class="category-name">${category.name}</div>
                <div class="category-type">${category.type}</div>
              </div>
            </div>
            <button onclick="deleteCategory('${doc.id}')" class="btn-danger">Удалить</button>
          `;
          categoriesList.appendChild(categoryElement);
        });
      };

      window.addCategory = async function () {
        const name = document.getElementById("category-name").value;
        const type = document.getElementById("category-type").value;
        const icon = document.getElementById("category-icon").value;
        const color = document.getElementById("category-color").value;

        if (!name) return alert("Введите название категории");

        try {
          await addDoc(
            collection(db, `users/${auth.currentUser.uid}/categories`),
            {
              name,
              type,
              icon,
              color,
              createdAt: serverTimestamp(),
            }
          );

          document.getElementById("category-name").value = "";
          loadCategories();
        } catch (error) {
          alert("Ошибка добавления категории: " + error.message);
        }
      };

      window.deleteCategory = async function (categoryId) {
        if (!confirm("Удалить категорию?")) return;

        try {
          await deleteDoc(
            doc(db, `users/${auth.currentUser.uid}/categories`, categoryId)
          );
          loadCategories();
        } catch (error) {
          alert("Ошибка удаления категории: " + error.message);
        }
      };

      // Лимиты
      window.loadLimits = async function () {
        if (!auth.currentUser) return;

        const limitsRef = collection(
          db,
          `users/${auth.currentUser.uid}/limits`
        );
        const snapshot = await getDocs(limitsRef);
        const limitsList = document.getElementById("limits-list");
        limitsList.innerHTML = "";

        snapshot.forEach((doc) => {
          const limit = doc.data();
          const limitElement = document.createElement("div");
          limitElement.className = "limit-item";
          limitElement.innerHTML = `
            <div class="limit-info">
              <div class="limit-category">${limit.category}</div>
              <div class="limit-amount">${limit.amount} ₽ / ${
            limit.period
          }</div>
              <div class="limit-progress">
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${Math.min(
                    100,
                    (limit.spent / limit.amount) * 100
                  )}%"></div>
                </div>
                <span>${limit.spent} / ${limit.amount} ₽</span>
              </div>
            </div>
            <button onclick="deleteLimit('${
              doc.id
            }')" class="btn-danger">Удалить</button>
          `;
          limitsList.appendChild(limitElement);
        });
      };

      window.addLimit = async function () {
        const category = document.getElementById("limit-category").value;
        const amount = parseFloat(
          document.getElementById("limit-amount").value
        );
        const period = document.getElementById("limit-period").value;

        if (!category || !amount) return alert("Заполните все поля");

        try {
          await addDoc(collection(db, `users/${auth.currentUser.uid}/limits`), {
            category,
            amount,
            period,
            spent: 0,
            createdAt: serverTimestamp(),
          });

          document.getElementById("limit-category").value = "";
          document.getElementById("limit-amount").value = "";
          loadLimits();
        } catch (error) {
          alert("Ошибка добавления лимита: " + error.message);
        }
      };

      window.deleteLimit = async function (limitId) {
        if (!confirm("Удалить лимит?")) return;

        try {
          await deleteDoc(
            doc(db, `users/${auth.currentUser.uid}/limits`, limitId)
          );
          loadLimits();
        } catch (error) {
          alert("Ошибка удаления лимита: " + error.message);
        }
      };

      // Цели
      window.loadGoals = async function () {
        if (!auth.currentUser) return;

        const goalsRef = collection(db, `users/${auth.currentUser.uid}/goals`);
        const snapshot = await getDocs(goalsRef);
        const goalsList = document.getElementById("goals-list");
        goalsList.innerHTML = "";

        snapshot.forEach((doc) => {
          const goal = doc.data();
          const progress = (goal.current / goal.target) * 100;
          const goalElement = document.createElement("div");
          goalElement.className = "goal-item";
          goalElement.innerHTML = `
            <div class="goal-info">
              <div class="goal-name">${goal.name}</div>
              <div class="goal-deadline">До: ${new Date(
                goal.deadline.seconds * 1000
              ).toLocaleDateString()}</div>
              <div class="goal-progress">
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${Math.min(
                    100,
                    progress
                  )}%"></div>
                </div>
                <span>${goal.current} / ${goal.target} ₽</span>
              </div>
            </div>
            <div class="goal-actions">
              <button onclick="addToGoal('${
                doc.id
              }')" class="btn">Пополнить</button>
              <button onclick="deleteGoal('${
                doc.id
              }')" class="btn-danger">Удалить</button>
            </div>
          `;
          goalsList.appendChild(goalElement);
        });
      };

      window.addGoal = async function () {
        const name = document.getElementById("goal-name").value;
        const target = parseFloat(document.getElementById("goal-target").value);
        const deadline = document.getElementById("goal-deadline").value;

        if (!name || !target || !deadline) return alert("Заполните все поля");

        try {
          await addDoc(collection(db, `users/${auth.currentUser.uid}/goals`), {
            name,
            target,
            current: 0,
            deadline: new Date(deadline),
            createdAt: serverTimestamp(),
          });

          document.getElementById("goal-name").value = "";
          document.getElementById("goal-target").value = "";
          document.getElementById("goal-deadline").value = "";
          loadGoals();
        } catch (error) {
          alert("Ошибка добавления цели: " + error.message);
        }
      };

      window.addToGoal = async function (goalId) {
        const amount = prompt("Сумма для пополнения цели:");
        if (!amount || isNaN(amount)) return;

        try {
          const goalRef = doc(
            db,
            `users/${auth.currentUser.uid}/goals`,
            goalId
          );
          const goalDoc = await getDoc(goalRef);
          const currentAmount = goalDoc.data().current + parseFloat(amount);

          await updateDoc(goalRef, { current: currentAmount });
          loadGoals();
        } catch (error) {
          alert("Ошибка пополнения цели: " + error.message);
        }
      };

      window.deleteGoal = async function (goalId) {
        if (!confirm("Удалить цель?")) return;

        try {
          await deleteDoc(
            doc(db, `users/${auth.currentUser.uid}/goals`, goalId)
          );
          loadGoals();
        } catch (error) {
          alert("Ошибка удаления цели: " + error.message);
        }
      };

      // Аналитика
      window.loadAnalytics = async function () {
        if (!auth.currentUser) return;

        const transactionsRef = collection(
          db,
          `users/${auth.currentUser.uid}/transactions`
        );
        const snapshot = await getDocs(transactionsRef);

        let totalIncome = 0;
        let totalExpense = 0;
        const categoryExpenses = {};

        snapshot.forEach((doc) => {
          const transaction = doc.data();
          if (transaction.type === "income") {
            totalIncome += transaction.amount;
          } else {
            totalExpense += transaction.amount;
            categoryExpenses[transaction.category] =
              (categoryExpenses[transaction.category] || 0) +
              transaction.amount;
          }
        });

        document.getElementById("total-income").textContent =
          totalIncome.toFixed(2);
        document.getElementById("total-expense").textContent =
          totalExpense.toFixed(2);
        document.getElementById("balance").textContent = (
          totalIncome - totalExpense
        ).toFixed(2);

        // Топ категории расходов
        const topCategories = Object.entries(categoryExpenses)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 5);

        const topCategoriesList = document.getElementById("top-categories");
        topCategoriesList.innerHTML = "";

        topCategories.forEach(([category, amount]) => {
          const item = document.createElement("div");
          item.className = "category-stat";
          item.innerHTML = `<span>${category}</span><span>${amount.toFixed(
            2
          )} ₽</span>`;
          topCategoriesList.appendChild(item);
        });
      };

      // Настройки
      window.loadSettings = async function () {
        if (!auth.currentUser) return;

        const userRef = doc(db, `users/${auth.currentUser.uid}/profile/main`);
        try {
          const userDoc = await getDoc(userRef);
          if (userDoc.exists()) {
            const userData = userDoc.data();
            document.getElementById("user-name").value = userData.name || "";
            document.getElementById("user-email").value =
              userData.email || auth.currentUser.email;
            document.getElementById("theme-select").value =
              userData.theme || "light";
          }
        } catch (error) {
          console.log("Настройки пользователя не найдены");
        }
      };

      window.updateProfile = async function () {
        const name = document.getElementById("user-name").value;
        const email = document.getElementById("user-email").value;

        try {
          const userRef = doc(db, `users/${auth.currentUser.uid}/profile/main`);
          await setDoc(
            userRef,
            {
              name,
              email,
              updatedAt: serverTimestamp(),
            },
            { merge: true }
          );

          alert("Профиль обновлен");
        } catch (error) {
          alert("Ошибка обновления профиля: " + error.message);
        }
      };

      window.updateSettings = async function () {
        const theme = document.getElementById("theme-select").value;

        try {
          const userRef = doc(db, `users/${auth.currentUser.uid}/profile/main`);
          await setDoc(
            userRef,
            {
              theme,
              updatedAt: serverTimestamp(),
            },
            { merge: true }
          );

          document.body.className = theme;
          alert("Настройки сохранены");
        } catch (error) {
          alert("Ошибка сохранения настроек: " + error.message);
        }
      };

      window.inviteUser = async function () {
        const email = document.getElementById("invite-email").value;
        if (!email) return alert("Введите email");

        try {
          await addDoc(
            collection(db, `users/${auth.currentUser.uid}/invites`),
            {
              email,
              status: "pending",
              createdAt: serverTimestamp(),
            }
          );

          document.getElementById("invite-email").value = "";
          alert("Приглашение отправлено");
        } catch (error) {
          alert("Ошибка отправки приглашения: " + error.message);
        }
      };

      window.exportData = async function () {
        if (!auth.currentUser) return;

        try {
          const transactionsRef = collection(
            db,
            `users/${auth.currentUser.uid}/transactions`
          );
          const snapshot = await getDocs(transactionsRef);

          const data = [];
          snapshot.forEach((doc) => {
            const transaction = doc.data();
            data.push({
              date: new Date(
                transaction.date.seconds * 1000
              ).toLocaleDateString(),
              description: transaction.description,
              amount: transaction.amount,
              type: transaction.type,
              category: transaction.category,
            });
          });

          const csv = [
            ["Дата", "Описание", "Сумма", "Тип", "Категория"],
            ...data.map((row) => [
              row.date,
              row.description,
              row.amount,
              row.type,
              row.category,
            ]),
          ]
            .map((row) => row.join(","))
            .join("\n");

          const blob = new Blob([csv], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "budget_export.csv";
          a.click();
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert("Ошибка экспорта данных: " + error.message);
        }
      };

      // Notification system
      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Auth state observer
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          userNameEl.textContent = user.displayName || user.email;
          showMainApp();
          loadTransactions();
        } else {
          currentUser = null;
          showAuthScreen();
        }
      });

      function showMainApp() {
        loadingScreen.classList.add("hidden");
        authScreen.classList.add("hidden");
        mainApp.classList.add("active");
      }

      function showAuthScreen() {
        loadingScreen.classList.add("hidden");
        authScreen.classList.remove("hidden");
        mainApp.classList.remove("active");
      }

      // Login
      loginBtn.addEventListener("click", async () => {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;

        if (!email || !password) {
          showNotification("Заполните все поля", "error");
          return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = "Вход...";

        try {
          await signInWithEmailAndPassword(auth, email, password);
          showNotification("Добро пожаловать!");
        } catch (error) {
          showNotification("Ошибка входа: " + error.message, "error");
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = "Войти";
        }
      });

      // Register
      registerBtn.addEventListener("click", async () => {
        const name = document.getElementById("register-name").value;
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;

        if (!name || !email || !password) {
          showNotification("Заполните все поля", "error");
          return;
        }

        if (password.length < 6) {
          showNotification(
            "Пароль должен содержать минимум 6 символов",
            "error"
          );
          return;
        }

        registerBtn.disabled = true;
        registerBtn.textContent = "Регистрация...";

        try {
          const result = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          await updateProfile(result.user, { displayName: name });
          showNotification("Аккаунт создан!");
        } catch (error) {
          showNotification("Ошибка регистрации: " + error.message, "error");
        } finally {
          registerBtn.disabled = false;
          registerBtn.textContent = "Зарегистрироваться";
        }
      });

      // Add transaction
      transactionForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentUser) return;

        const type = document.getElementById("transaction-type").value;
        const amount = parseFloat(
          document.getElementById("transaction-amount").value
        );
        const description = document.getElementById(
          "transaction-description"
        ).value;
        const category = document.getElementById("transaction-category").value;

        if (!type || !amount || !description || !category) {
          showNotification("Заполните все поля", "error");
          return;
        }

        try {
          await addDoc(collection(db, "transactions"), {
            userId: currentUser.uid,
            type: type,
            amount: amount,
            description: description,
            category: category,
            date: new Date(),
            timestamp: Date.now(),
          });

          transactionForm.reset();
          showNotification("Операция добавлена!");
        } catch (error) {
          showNotification("Ошибка добавления: " + error.message, "error");
        }
      });

      // Load transactions
      function loadTransactions() {
        if (!currentUser) return;

        const q = query(
          collection(db, "transactions"),
          where("userId", "==", currentUser.uid),
          orderBy("timestamp", "desc")
        );

        onSnapshot(q, (snapshot) => {
          transactions = [];
          snapshot.forEach((doc) => {
            transactions.push({ id: doc.id, ...doc.data() });
          });

          displayTransactions();
          updateSummary();
        });
      }

      // Display transactions
      function displayTransactions() {
        transactionList.innerHTML = "";

        if (transactions.length === 0) {
          transactionList.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">Пока нет операций</div>';
          return;
        }

        transactions.forEach((transaction) => {
          const item = document.createElement("div");
          item.className = "transaction-item";

          const date = new Date(transaction.timestamp);
          const formattedDate =
            date.toLocaleDateString("ru-RU") +
            " " +
            date.toLocaleTimeString("ru-RU", {
              hour: "2-digit",
              minute: "2-digit",
            });

          item.innerHTML = `
                    <div class="transaction-info">
                        <div class="transaction-description">${
                          transaction.description
                        }</div>
                        <div class="transaction-category">${getCategoryName(
                          transaction.category
                        )}</div>
                    </div>
                    <div class="transaction-amount ${transaction.type}">
                        ${
                          transaction.type === "income" ? "+" : "-"
                        }${transaction.amount.toLocaleString("ru-RU")} ₽
                    </div>
                    <div class="transaction-date">${formattedDate}</div>
                `;

          transactionList.appendChild(item);
        });
      }

      // Update summary
      function updateSummary() {
        const income = transactions
          .filter((t) => t.type === "income")
          .reduce((sum, t) => sum + t.amount, 0);
        const expenses = transactions
          .filter((t) => t.type === "expense")
          .reduce((sum, t) => sum + t.amount, 0);
        const balance = income - expenses;

        totalIncomeEl.textContent = income.toLocaleString("ru-RU") + " ₽";
        totalExpensesEl.textContent = expenses.toLocaleString("ru-RU") + " ₽";
        balanceEl.textContent = balance.toLocaleString("ru-RU") + " ₽";

        balanceEl.style.color = balance >= 0 ? "#27ae60" : "#e74c3c";
      }

      // Get category name
      function getCategoryName(category) {
        const categories = {
          food: "Продукты",
          transport: "Транспорт",
          utilities: "Коммунальные",
          entertainment: "Развлечения",
          salary: "Зарплата",
          other: "Другое",
        };
        return categories[category] || category;
      }

      // Hide loading screen after Firebase init
      setTimeout(() => {
        if (loadingScreen && !loadingScreen.classList.contains("hidden")) {
          loadingScreen.classList.add("hidden");
          if (!currentUser) {
            showAuthScreen();
          }
        }
      }, 2000);

      console.log("🔥 Семейный бюджет с Firebase запущен!");
    </script>
  </body>
</html>
